import{e as $,u as p,f as D,h as P,j}from"./index-CQxvzdpf.js";import{d as E,r as l,E as r}from"./.pnpm-CR973naf.js";const q=E("fileListStore",()=>{const i=l(!1),a=l({surl:"",url:"",pwd:"",dir:"/",password:""}),f=l(null),x=()=>{const t=a.value.dir.split("/");t.pop();const v=t.join("/");return v===""?"/":v},z=async()=>{if(!(!f.value||!await f.value.validate())){if(a.value.surl==="")return r.error("获取链接surl失败");try{c.value=[],i.value=!0;const t=await $(a.value);n.value=t.data,a.value.dir!=="/"&&n.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:x(),server_filename:"..",dlink:""}),r.success("获取文件列表成功")}finally{i.value=!1}}},o=l({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),n=l({uk:0,shareid:0,randsk:"",list:[]}),c=l([]),h=l([]),S=async(t,v=!1)=>{var L,k;if(i.value){r.info("请勿重复点击~");return}let s=t?[t]:c.value.filter(e=>e.isdir!==1);const d=p().config.min_single_file;if(t){const e=n.value.list.find(u=>u.fs_id===t);if((e==null?void 0:e.size)??0<d){r.error("文件过小不会被解析!");return}}else s.length!==c.value.length&&r.error("文件夹不会被解析!"),s=s,console.log(d),s=s.filter(e=>(console.log(e.size,d),e.size>d)),t===void 0&&s.length!==c.value.length&&r.error("文件过小不会被解析!"),s=s.map(e=>e.fs_id);if(s.length>(((k=(L=p())==null?void 0:L.config)==null?void 0:k.max_once)??20)){r.error(`一次最多解析${p().config.max_once}个文件`);return}if(s.length===0){r.error("满足要求的文件数量为0");return}let _;try{i.value=!0;const e={uk:n.value.uk,shareid:n.value.shareid,randsk:n.value.randsk,fs_ids:s,password:a.value.password,url:a.value.url,surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd};if(o.value.hit_captcha){if(!o.value.vcode_str||!o.value.vcode_input){r.error("请先输入验证码");return}e.vcode_str=o.value.vcode_str,e.vcode_input=o.value.vcode_input}if(_=await D(e),r.success("解析成功,下载链接请下滑"),o.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""},v)return i.value=!1,await m(),_.data.map(u=>({...u,index:0}));h.value=_.data.map(u=>({...u,index:0}))}catch(e){const{code:u,message:y}=e;if(u&&y&&y.includes("验证码")){const F=await P({password:a.value.password});o.value={hit_captcha:!0,vcode_str:F.data.vcode,vcode_img:F.data.img,vcode_input:""}}}finally{i.value=!1,await m()}},w=l({group_name:"",count:0,size:0}),g=l(!1),m=async()=>{try{i.value=!0;const t=await j();w.value=t.data,g.value=!1}catch{g.value=!0}finally{i.value=!1}};return{pending:i,fileList:n,getFileList:z,getFileListForm:a,getFileListFormRef:f,selectedRows:c,downloadLinks:h,getDownloadLinks:S,limitForm:w,getLimit:m,hitLimit:g,vcode:o}});export{q as u};
