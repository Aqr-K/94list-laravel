import{d as w,e as p,f as k}from"./index-ctO0osHI.js";import{d as L,r as i,E as l}from"./.pnpm-iATkil5N.js";const _=L("fileListStore",()=>{const t=i(!1),s=i({surl:"",url:"",pwd:"",dir:"/",password:""}),c=i(null),m=()=>{const e=s.value.dir.split("/");e.pop();const n=e.join("/");return n===""?"/":n},r=i({sign:"",timestamp:0}),f=async()=>{try{t.value=!0;const e=await k({surl:s.value.surl,uk:a.value.uk,shareid:a.value.shareid,password:s.value.password});r.value.sign=e.data.sign,r.value.timestamp=e.data.timestamp,l.success("获取签名成功")}finally{t.value=!1}},d=async()=>{Date.now()/1e3-r.value.timestamp>250?(l.info("获取签名中"),await f()):l.success("签名未过期,无需更新")},g=async()=>{if(!(!c.value||!await c.value.validate())){if(s.value.surl==="")return l.error("获取链接surl失败");try{o.value=[],t.value=!0;const e=await w(s.value);a.value=e.data,s.value.dir!=="/"&&a.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:m(),server_filename:"..",dlink:""}),l.success("获取文件列表成功")}finally{t.value=!1,await d()}}},a=i({uk:0,shareid:0,randsk:"",list:[]}),o=i([]),v=i([]);return{pending:t,fileList:a,getFileList:g,getFileListForm:s,getFileListFormRef:c,selectedRows:o,downloadLinks:v,getDownloadLinks:async e=>{const n=e?[e]:o.value.filter(u=>u.isdir!==1).map(u=>u.fs_id);n.length!==o.value.length&&l.error("文件夹不会被解析!"),await d();try{t.value=!0;const u=await p({uk:a.value.uk,shareid:a.value.shareid,randsk:a.value.randsk,fs_ids:n,sign:r.value.sign,timestamp:r.value.timestamp,password:s.value.password});v.value=u.data,l.success("解析成功")}finally{t.value=!1}}}});export{_ as u};
