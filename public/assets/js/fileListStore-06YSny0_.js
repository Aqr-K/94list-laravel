import{e as $,u as y,f as D,h as P,j}from"./index-DDddeY1G.js";import{d as z,r as s,E as o}from"./.pnpm-CR973naf.js";const R=z("fileListStore",()=>{const t=s(!1),i=s({surl:"",url:"",pwd:"",dir:"/",password:""}),d=s(null),F=()=>{const e=i.value.dir.split("/");e.pop();const c=e.join("/");return c===""?"/":c},x=async()=>{if(!(!d.value||!await d.value.validate())){if(i.value.surl==="")return o.error("获取链接surl失败");try{u.value=[],t.value=!0;const e=await $(i.value);l.value=e.data,i.value.dir!=="/"&&l.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:F(),server_filename:"..",dlink:""}),o.success("获取文件列表成功")}finally{t.value=!1}}},r=s({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),l=s({uk:0,shareid:0,randsk:"",list:[]}),u=s([]),_=s([]),S=async(e,c=!1)=>{var h,w;if(t.value){o.info("请勿重复点击~");return}const m=e?[e]:u.value.filter(a=>a.isdir!==1).map(a=>a.fs_id);if(e===void 0&&m.length!==u.value.length&&o.error("文件夹不会被解析!"),m.length>(((w=(h=y())==null?void 0:h.config)==null?void 0:w.max_once)??20)){o.error(`一次最多解析${y().config.max_once}个文件`);return}let g;try{t.value=!0;const a={uk:l.value.uk,shareid:l.value.shareid,randsk:l.value.randsk,fs_ids:m,password:i.value.password,url:i.value.url};if(r.value.hit_captcha&&(a.vcode_str=r.value.vcode_str,a.vcode_input=r.value.vcode_input),g=await D(a),o.success("解析成功,下载链接请下滑"),c)return t.value=!1,await f(),g.data.map(n=>({...n,index:0}));_.value=g.data.map(n=>({...n,index:0})),r.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}}catch(a){const{code:n,message:L}=a;if(n&&L&&L.includes("验证码")){const k=await P();r.value={hit_captcha:!0,vcode_str:k.data.vcode,vcode_img:k.data.img,vcode_input:""}}}finally{t.value=!1,await f()}},p=s({group_name:"",count:0,size:0}),v=s(!1),f=async()=>{try{t.value=!0;const e=await j();p.value=e.data,v.value=!1}catch{v.value=!0}finally{t.value=!1}};return{pending:t,fileList:l,getFileList:x,getFileListForm:i,getFileListFormRef:d,selectedRows:u,downloadLinks:_,getDownloadLinks:S,limitForm:p,getLimit:f,hitLimit:v,vcode:r}});export{R as u};
